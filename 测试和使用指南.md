# Open Notebook 测试和使用指南

## 📋 目录

- [快速开始](#快速开始)
- [启动服务](#启动服务)
- [验证服务状态](#验证服务状态)
- [测试功能](#测试功能)
- [使用界面](#使用界面)
- [查看日志](#查看日志)
- [停止服务](#停止服务)
- [故障排除](#故障排除)

---

## 🚀 快速开始

### 前置检查

1. **确认Docker已安装**
```bash
docker --version
docker compose version
```

2. **确认端口未被占用**
```bash
# 检查8502端口（前端）
lsof -i :8502 || echo "端口8502可用"

# 检查5055端口（API）
lsof -i :5055 || echo "端口5055可用"
```

3. **确认配置文件存在**
```bash
cd /home/zhengyu/yu_zheng/open-notebook
ls -la docker-compose.yml
```

---

## 🎯 启动服务

### 方法一：后台启动（推荐）

```bash
cd /home/zhengyu/yu_zheng/open-notebook
docker compose up -d
```

**输出示例**：
```
[+] Running 2/2
 ✔ Container open-notebook-open_notebook-1  Started
```

### 方法二：前台启动（查看实时日志）

```bash
cd /home/zhengyu/yu_zheng/open-notebook
docker compose up
```

按 `Ctrl+C` 停止服务。

---

## ✅ 验证服务状态

### 1. 检查容器状态

```bash
docker compose ps
```

**期望输出**：
```
NAME                          STATUS          PORTS
open-notebook-open_notebook-1   Up 30 seconds   0.0.0.0:5055->5055/tcp, 0.0.0.0:8502->8502/tcp
```

### 2. 检查健康状态

```bash
# 检查API健康状态
curl http://localhost:5055/health

# 期望输出：
# {"status":"healthy"}
```

### 3. 检查API文档

打开浏览器访问：http://localhost:5055/docs

应该能看到FastAPI的交互式API文档。

### 4. 检查前端

打开浏览器访问：http://localhost:8502

应该能看到Open Notebook的登录/主界面。

---

## 🔍 测试功能

### 测试1：验证环境变量配置

```bash
# 进入容器
docker compose exec open_notebook bash

# 检查环境变量
env | grep OPENAI_COMPATIBLE

# 应该看到：
# OPENAI_COMPATIBLE_BASE_URL=https://api.univibe.cc/openai/v1
# OPENAI_COMPATIBLE_API_KEY=sk-i5oksIo7WZ3vSufagSK7bLKh9TNHyPWc

# 退出容器
exit
```

### 测试2：测试中转站连接

```bash
# 测试模型列表端点
curl https://api.univibe.cc/openai/v1/models \
  -H "Authorization: Bearer sk-i5oksIo7WZ3vSufagSK7bLKh9TNHyPWc" \
  -H "Content-Type: application/json"

# 如果成功，应该返回模型列表JSON
```

### 测试3：测试API端点

```bash
# 测试配置端点
curl http://localhost:5055/api/config

# 应该返回配置信息，包括可用的提供商

# 测试模型列表
curl http://localhost:5055/api/models

# 应该返回配置的模型列表
```

### 测试4：在容器内测试API调用

```bash
# 进入容器
docker compose exec open_notebook bash

# 测试Python环境
python3 -c "
import os
print('Base URL:', os.getenv('OPENAI_COMPATIBLE_BASE_URL'))
print('API Key:', os.getenv('OPENAI_COMPATIBLE_API_KEY')[:20] + '...')
"

# 退出容器
exit
```

---

## 🖥️ 使用界面

### 1. 访问前端

打开浏览器：http://localhost:8502

### 2. 首次使用步骤

#### 步骤1：检查设置

1. 点击左侧边栏的 **Settings**（设置）图标
2. 进入 **Models**（模型）标签
3. 检查 **Provider Support Matrix**
4. 应该能看到 **"OpenAI Compatible"** 提供商

#### 步骤2：配置模型

在Settings → Models中配置：

- **Chat Model（聊天模型）**：
  - 选择 "OpenAI Compatible" 提供商
  - 选择可用的模型（如 `gpt-4`, `gpt-3.5-turbo` 等）

- **Embedding Model（嵌入模型）**：
  - 选择 "OpenAI Compatible" 提供商
  - 选择嵌入模型（如 `text-embedding-3-small`）

- **Speech-to-Text（语音转文字）**：
  - 如果中转站支持，选择 "OpenAI Compatible"
  - 选择STT模型（如 `whisper-1`）

- **Text-to-Speech（文字转语音）**：
  - 如果中转站支持，选择 "OpenAI Compatible"
  - 选择TTS模型（如 `tts-1`）

#### 步骤3：创建第一个笔记本

1. 点击左侧边栏的 **"+"** 或 **"New Notebook"**
2. 输入笔记本名称（如 "测试笔记本"）
3. 输入描述（可选）
4. 点击创建

#### 步骤4：添加源文件

1. 在左侧 **Sources** 栏点击 **"Add Source"**
2. 选择源文件类型：
   - **Upload File**：上传PDF、文本文件等
   - **Add URL**：添加网页URL
   - **Add Text**：直接输入文本
3. 等待处理完成（会显示处理进度）

#### 步骤5：开始对话

1. 切换到右侧 **Chat** 栏
2. 在输入框中输入问题，例如：
   - "总结一下这个文档的主要内容"
   - "文档中提到了哪些关键概念？"
3. 按回车发送
4. AI会基于你添加的源文件内容回答

#### 步骤6：测试搜索

1. 使用顶部的搜索框
2. 输入关键词
3. 查看搜索结果（全文搜索 + 向量搜索）

---

## 📊 查看日志

### 实时查看日志

```bash
# 查看所有服务日志
docker compose logs -f

# 查看最近100行
docker compose logs --tail=100

# 只查看特定服务
docker compose logs -f open_notebook
```

### 查看特定内容

```bash
# 查看错误日志
docker compose logs | grep -i error

# 查看API相关日志
docker compose logs | grep -i "api\|openai\|compatible"

# 查看数据库相关日志
docker compose logs | grep -i "database\|surreal\|migration"
```

### 常见日志信息

**启动成功**：
```
✅ Database is already at the latest version
✅ API initialization completed successfully
Starting Open Notebook API server on 127.0.0.1:5055
```

**错误示例**：
```
❌ Failed to connect to database
❌ API initialization failed
Connection refused
```

---

## 🛑 停止服务

### 停止但保留数据

```bash
docker compose stop
```

### 停止并删除容器（数据保留）

```bash
docker compose down
```

### 完全清理（删除容器和数据）

**⚠️ 警告：这会删除所有数据！**

```bash
# 停止并删除容器
docker compose down

# 删除数据目录（可选）
rm -rf notebook_data surreal_data
```

---

## 🔧 故障排除

### 问题1：容器无法启动

**检查步骤**：
```bash
# 1. 查看详细错误信息
docker compose logs

# 2. 检查端口占用
lsof -i :8502
lsof -i :5055

# 3. 检查Docker资源
docker system df
docker system prune  # 清理未使用的资源（谨慎使用）
```

**解决方案**：
- 如果端口被占用，修改 `docker-compose.yml` 中的端口映射
- 如果磁盘空间不足，清理Docker资源

### 问题2：无法访问前端

**检查步骤**：
```bash
# 1. 检查容器是否运行
docker compose ps

# 2. 检查端口映射
docker compose port open_notebook 8502

# 3. 检查容器日志
docker compose logs open_notebook | tail -50
```

**解决方案**：
- 确认容器状态为 "Up"
- 检查防火墙设置
- 尝试使用 `127.0.0.1:8502` 而不是 `localhost:8502`

### 问题3：API连接失败

**检查步骤**：
```bash
# 1. 测试API健康检查
curl http://localhost:5055/health

# 2. 检查环境变量
docker compose exec open_notebook env | grep OPENAI

# 3. 测试中转站连接
curl https://api.univibe.cc/openai/v1/models \
  -H "Authorization: Bearer sk-i5oksIo7WZ3vSufagSK7bLKh9TNHyPWc"
```

**解决方案**：
- 确认环境变量正确设置
- 检查中转站是否可访问
- 验证API密钥是否有效

### 问题4：模型不可用

**检查步骤**：
```bash
# 1. 检查提供商状态
curl http://localhost:5055/api/models/providers

# 2. 查看模型列表
curl http://localhost:5055/api/models

# 3. 检查中转站模型列表
curl https://api.univibe.cc/openai/v1/models \
  -H "Authorization: Bearer sk-i5oksIo7WZ3vSufagSK7bLKh9TNHyPWc"
```

**解决方案**：
- 确认中转站返回了模型列表
- 检查模型名称是否匹配
- 查看Open Notebook日志中的错误信息

### 问题5：数据库连接失败

**检查步骤**：
```bash
# 1. 查看数据库相关日志
docker compose logs | grep -i "surreal\|database"

# 2. 检查数据库环境变量
docker compose exec open_notebook env | grep SURREAL
```

**解决方案**：
- 确认SurrealDB在容器内正常运行
- 检查数据库配置环境变量
- 查看数据库迁移日志

---

## 📝 常用命令速查

```bash
# ===== 启动和停止 =====
docker compose up -d              # 后台启动
docker compose up                 # 前台启动（查看日志）
docker compose stop               # 停止服务
docker compose down               # 停止并删除容器
docker compose restart            # 重启服务

# ===== 查看状态 =====
docker compose ps                 # 查看容器状态
docker compose logs -f            # 实时查看日志
docker compose logs --tail=100    # 查看最近100行

# ===== 进入容器 =====
docker compose exec open_notebook bash    # 进入容器shell
docker compose exec open_notebook sh      # 进入容器sh

# ===== 检查配置 =====
docker compose config             # 验证配置文件
docker compose config --services  # 列出服务

# ===== 清理 =====
docker compose down -v            # 停止并删除卷（数据）
docker compose down --remove-orphans  # 删除孤立容器
```

---

## 🎯 完整测试流程

### 第一次使用完整流程

```bash
# 1. 启动服务
cd /home/zhengyu/yu_zheng/open-notebook
docker compose up -d

# 2. 等待30秒让服务完全启动
sleep 30

# 3. 检查服务状态
docker compose ps

# 4. 测试API健康
curl http://localhost:5055/health

# 5. 测试中转站连接
curl https://api.univibe.cc/openai/v1/models \
  -H "Authorization: Bearer sk-i5oksIo7WZ3vSufagSK7bLKh9TNHyPWc"

# 6. 查看日志确认无错误
docker compose logs --tail=50

# 7. 打开浏览器访问
# 前端：http://localhost:8502
# API文档：http://localhost:5055/docs
```

---

## ✅ 验证清单

使用前确认以下项目：

- [ ] Docker和Docker Compose已安装
- [ ] 端口8502和5055未被占用
- [ ] `docker-compose.yml` 文件存在且配置正确
- [ ] 中转站URL可访问
- [ ] API密钥有效
- [ ] 容器成功启动（`docker compose ps` 显示 "Up"）
- [ ] API健康检查通过（`curl http://localhost:5055/health`）
- [ ] 前端可访问（浏览器打开 http://localhost:8502）
- [ ] 在Settings中能看到"OpenAI Compatible"提供商
- [ ] 可以创建笔记本
- [ ] 可以添加源文件
- [ ] 可以开始对话

---

## 🎉 开始使用

完成以上步骤后，你就可以开始使用Open Notebook了！

**推荐操作**：
1. 创建一个测试笔记本
2. 上传一个PDF文件作为源文件
3. 在Chat中提问，测试AI回答
4. 尝试搜索功能
5. 探索其他功能（笔记、播客等）

**需要帮助？**
- 查看日志：`docker compose logs -f`
- 检查状态：`docker compose ps`
- 查看API文档：http://localhost:5055/docs

---

*最后更新：2024年*
